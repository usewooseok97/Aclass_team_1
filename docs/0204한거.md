# 2024-02-04 작업 내역

## 해결된 문제들

| 문제 | 원인 | 해결 방법 | 상태 |
|------|------|----------|------|
| 회원가입/로그인 500 에러 | Vercel 환경변수 미설정 | Vercel 대시보드에서 환경변수 추가 | ✅ |
| GitHub Actions Python 에러 | `python -c` 실행 시 `__file__` 미정의 | `main.py` 통합 실행으로 워크플로우 수정 | ✅ |
| ESM 모듈 import 에러 | `.js` 확장자 필요 | 모든 API 파일의 import 경로에 `.js` 추가 | ✅ |
| SPA 라우팅 404 | Vercel에서 직접 URL 접근 시 파일 못 찾음 | `vercel.json`에 rewrite 규칙 추가 | ✅ |
| API 패키지 미설치 | supabase, jwt, bcrypt 없음 | pnpm으로 패키지 설치 | ✅ |
| 네이버 지도 안 뜸 | Vercel 환경변수 미설정 | `VITE_NAVER_MAP_CLIENT_ID` 추가 | ✅ |

---

## 상세 내역

### 1. Vercel 환경변수 설정

Vercel 대시보드 → Settings → Environment Variables에 추가:

| 변수명 | 용도 |
|--------|------|
| `SUPABASE_URL` | Supabase 프로젝트 URL |
| `SUPABASE_ANON_KEY` | Supabase anon key |
| `JWT_SECRET` | JWT 토큰 서명용 시크릿 |
| `VITE_NAVER_MAP_CLIENT_ID` | 네이버 지도 클라이언트 ID |
| `VITE_GOOGLE_PLACES_API_KEY` | Google Places API 키 |

---

### 2. GitHub Actions 워크플로우 수정

**파일:** `.github/workflows/data-collection.yml`

**문제:** `python -c "from modules import ..."` 실행 시 `__file__`이 정의되지 않아 config import 실패

**해결:** `main.py` 통합 실행으로 변경

```yaml
- name: Run data collection
  run: |
    cd py_scripts
    python main.py
```

---

### 3. ESM import 확장자 수정

**문제:** `package.json`에 `"type": "module"` 설정 → ESM 모드에서 상대 경로 import 시 `.js` 확장자 필수

**수정된 파일 (8개):**
- `api/auth/login.ts`
- `api/auth/me.ts`
- `api/auth/signup.ts`
- `api/auth/withdraw.ts`
- `api/favorites/index.ts`
- `api/favorites/[festivalId].ts`
- `api/reviews/[festivalId].ts`
- `api/reviews/delete/[reviewId].ts`

**변경 내용:**
```typescript
// Before
import { supabase } from '../lib/supabase';
import { getUserFromRequest } from '../lib/auth';

// After
import { supabase } from '../lib/supabase.js';
import { getUserFromRequest } from '../lib/auth.js';
```

---

### 4. SPA 라우팅 404 해결

**파일:** `vercel.json`

**문제:** `/지역명` 또는 `/지역명/축제명` 경로에서 새로고침하면 Vercel 404 발생

**해결:** rewrite 규칙 추가

```json
{
  "rewrites": [
    {
      "source": "/api/:path*",
      "destination": "/api/:path*"
    },
    {
      "source": "/:path*",
      "destination": "/index.html"
    }
  ]
}
```

---

### 5. API 패키지 설치

**문제:** API에서 사용하는 패키지들이 `package.json`에 없음

**해결:**
```bash
pnpm add @supabase/supabase-js jsonwebtoken bcryptjs
pnpm add -D @types/jsonwebtoken @types/bcryptjs
```

**설치된 패키지:**
- `@supabase/supabase-js` - Supabase 클라이언트
- `jsonwebtoken` - JWT 토큰 생성/검증
- `bcryptjs` - 비밀번호 해싱
- `@types/jsonwebtoken` - TypeScript 타입
- `@types/bcryptjs` - TypeScript 타입

---

### 6. API 키 보안 설정

**프론트엔드 노출 키 (VITE_ 접두사):**

| 키 | 보안 조치 |
|---|---------|
| `VITE_NAVER_MAP_CLIENT_ID` | 공개 키, 제한 불필요 |
| `VITE_GOOGLE_PLACES_API_KEY` | Google Cloud Console에서 HTTP 리퍼러 + API 제한 설정 |

**Google API 키 제한 설정:**
1. Google Cloud Console → API 및 서비스 → 사용자 인증 정보
2. 애플리케이션 제한 → HTTP 리퍼러
3. 허용 도메인: `https://seoulfestivalmap.vercel.app/*`, `http://localhost:*`
4. API 제한 → Places API만 선택

---

## 남은 작업

- [ ] 회원가입/로그인 기능 테스트
- [ ] 네이버 지도 표시 테스트
- [ ] GitHub Actions 워크플로우 실행 테스트

---

## 참고 파일

- 계획 파일: `docs/0204plan.md`
- Vercel 설정: `vercel.json`
- GitHub Actions: `.github/workflows/data-collection.yml`
- API 엔드포인트: `api/` 폴더
