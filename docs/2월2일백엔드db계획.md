# Seoul Festival Map 백엔드 구현 계획

## 1. 백엔드 구현이 필요한 기능 목록

### 우선순위 1: 필수 (현재 localStorage 사용 중)
| 기능 | 현재 상태 | 필요 API |
|------|----------|---------|
| **찜하기** | localStorage (`festival_favorites`) | `POST/DELETE /api/favorites` |
| **축제 리뷰** | localStorage (`festival_reviews_{id}`) | `POST/GET /api/reviews` |

### 우선순위 2: 사용자 경험 개선
| 기능 | 현재 상태 | 필요 API |
|------|----------|---------|
| **사용자 인증** | 없음 (익명) | `POST /api/auth/signup, /login` |
| **회원 탈퇴** | 없음 | `DELETE /api/auth/withdraw` |
| **찜 목록 동기화** | 기기별 분리됨 | `GET /api/users/:id/favorites` |

### 우선순위 3: 데이터 실시간화 (Python 배치 → API)
| 기능 | 현재 상태 | 필요 API |
|------|----------|---------|
| **축제 데이터** | Python → JSON 파일 | `GET /api/festivals` |
| **맛집 데이터** | Python → JSON 파일 | `GET /api/places/:festivalId` |
| **날씨 데이터** | Python → JSON 파일 | `GET /api/weather` |

---

## 2. 선택한 기술 스택

### 백엔드 프레임워크 (JS/TS)

| 옵션 | 장점 | 단점 | 추천도 |
|------|------|------|--------|
| **Hono** | 초경량, Edge 최적화, TypeScript 네이티브 | 생태계 작음 | ⭐⭐⭐⭐⭐ |
| **Express.js** | 가장 큰 생태계, 자료 많음 | 오래됨, 보일러플레이트 | ⭐⭐⭐⭐ |
| **Fastify** | 빠름, 현대적 | 학습 곡선 | ⭐⭐⭐⭐ |
| **Next.js API Routes** | 프론트와 통합 | Vite에서 마이그레이션 필요 | ⭐⭐⭐ |

**✅ 선택: Express.js**
- 가장 큰 생태계, 자료 풍부
- 익숙한 문법
- TypeScript 지원 (@types/express)

### 데이터베이스

| 옵션 | 무료 티어 | 장점 | 단점 | 추천도 |
|------|----------|------|------|--------|
| **Supabase (PostgreSQL)** | 500MB, 무제한 API | Auth 내장, 실시간 | 복잡한 쿼리 학습 | ⭐⭐⭐⭐⭐ |
| **MongoDB Atlas** | 512MB | 스키마 유연 | 관계형 데이터 약함 | ⭐⭐⭐⭐ |
| **PlanetScale (MySQL)** | 5GB, 1B reads | 브랜칭, 빠름 | 외래키 제한 | ⭐⭐⭐⭐ |
| **Turso (SQLite)** | 9GB, Edge 최적화 | 매우 빠름 | 새로운 서비스 | ⭐⭐⭐⭐ |
| **Neon (PostgreSQL)** | 512MB | 서버리스 | 콜드 스타트 | ⭐⭐⭐ |

**✅ 선택: Supabase**
- PostgreSQL 기반 (강력한 쿼리)
- 실시간 구독 지원
- 무료 티어 충분

### 배포 플랫폼 (무료)

| 서비스 | 프론트엔드 | 백엔드 | DB | 특징 |
|--------|-----------|--------|-----|------|
| **Vercel** | ✅ 무료 | ✅ Edge Functions | ❌ | 가장 쉬움 |
| **Cloudflare Pages** | ✅ 무료 | ✅ Workers | ✅ D1 | 완전 무료 |
| **Render** | ✅ 무료 | ✅ 무료 (슬립) | ✅ PostgreSQL | 올인원 |
| **Railway** | ✅ | ✅ $5 크레딧/월 | ✅ | 편리함 |
| **Fly.io** | ❌ | ✅ 무료 | ✅ SQLite | 글로벌 |

**✅ 최종 선택 조합:**
```
프론트엔드: Vercel (무료, Vite 지원)
백엔드: Express.js + Vercel Serverless Functions (무료)
데이터베이스: Supabase (무료 500MB)
인증: 직접 구현 (전화번호 + 비밀번호)
```

---

## 3. 아키텍처

```
┌─────────────────────────────────────────────────────┐
│                    Vercel                           │
│  ┌─────────────────┐  ┌─────────────────────────┐  │
│  │  React + Vite   │  │  Express.js (Serverless)│  │
│  │  (Static)       │  │  /api/favorites         │  │
│  │                 │  │  /api/reviews           │  │
│  │                 │  │  /api/auth/*            │  │
│  └─────────────────┘  └───────────┬─────────────┘  │
└───────────────────────────────────┼─────────────────┘
                                    │
                    ┌───────────────▼───────────────┐
                    │         Supabase              │
                    │  ┌─────────────────────────┐  │
                    │  │      PostgreSQL         │  │
                    │  │  - users (전화번호)      │  │
                    │  │  - favorites            │  │
                    │  │  - reviews              │  │
                    │  └─────────────────────────┘  │
                    └───────────────────────────────┘
```

---

## 4. 데이터베이스 스키마 (PostgreSQL)

```sql
-- 사용자 테이블 (전화번호 + 비밀번호 인증)
CREATE TABLE users (
  id SERIAL PRIMARY KEY,                    -- 고유번호 (자동 증가)
  nickname VARCHAR(50) NOT NULL,            -- 닉네임
  phone VARCHAR(20) NOT NULL UNIQUE,        -- 전화번호 (로그인 ID)
  password_hash TEXT NOT NULL,              -- 비밀번호 (해시)
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 찜하기 테이블
CREATE TABLE favorites (
  id SERIAL PRIMARY KEY,                    -- 고유번호 (자동 증가)
  user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
  festival_id TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id, festival_id)
);

-- 리뷰 테이블
CREATE TABLE reviews (
  id SERIAL PRIMARY KEY,                    -- 고유번호 (자동 증가)
  user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
  festival_id TEXT NOT NULL,
  text TEXT NOT NULL CHECK (char_length(text) <= 10),
  rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
  x NUMERIC NOT NULL,
  y NUMERIC NOT NULL,
  font_size NUMERIC NOT NULL,
  rotate NUMERIC NOT NULL,
  color TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 인덱스
CREATE INDEX idx_users_phone ON users(phone);
CREATE INDEX idx_favorites_user ON favorites(user_id);
CREATE INDEX idx_favorites_festival ON favorites(festival_id);
CREATE INDEX idx_reviews_festival ON reviews(festival_id);
CREATE INDEX idx_reviews_user ON reviews(user_id);
```

---

## 5. API 엔드포인트 설계

### 인증 API
```typescript
// 회원가입
POST /api/auth/signup
Body: {
  nickname: string,      // 닉네임
  phone: string,         // 전화번호
  password: string,      // 비밀번호
  passwordConfirm: string // 비밀번호 확인
}

// 로그인
POST /api/auth/login
Body: {
  phone: string,         // 전화번호
  password: string       // 비밀번호
}

// 로그아웃
POST /api/auth/logout

// 현재 사용자 정보
GET /api/auth/me

// 회원 탈퇴
DELETE /api/auth/withdraw
```

### 찜하기 API
```typescript
GET    /api/favorites              // 내 찜 목록
POST   /api/favorites/:festivalId  // 찜하기 추가
DELETE /api/favorites/:festivalId  // 찜하기 취소
```

### 리뷰 API
```typescript
GET    /api/reviews/:festivalId    // 축제별 리뷰 목록
POST   /api/reviews/:festivalId    // 리뷰 작성
DELETE /api/reviews/:reviewId      // 리뷰 삭제 (본인만)
```

---

## 6. 구현 순서 (단계별 체크리스트)

### Phase 1: 환경 설정
- [ ] 1-1. Supabase 프로젝트 생성
- [ ] 1-2. Supabase에서 위 SQL로 테이블 생성
- [ ] 1-3. Vercel 프로젝트 연결
- [ ] 1-4. 프로젝트에 `/api` 폴더 생성
- [ ] 1-5. 필요한 패키지 설치
  ```bash
  npm install express @supabase/supabase-js bcryptjs jsonwebtoken
  npm install -D @types/express @types/bcryptjs @types/jsonwebtoken
  ```

### Phase 2: 인증 시스템 구현
- [ ] 2-1. `/api/auth/signup.ts` - 회원가입 API
  - 닉네임, 전화번호, 비밀번호, 비밀번호 확인 검증
  - 비밀번호 해시화 (bcrypt)
  - 전화번호 중복 체크
- [ ] 2-2. `/api/auth/login.ts` - 로그인 API
  - 전화번호 + 비밀번호 검증
  - JWT 토큰 발급
- [ ] 2-3. `/api/auth/logout.ts` - 로그아웃 API
  - 토큰 무효화
- [ ] 2-4. `/api/auth/me.ts` - 현재 사용자 정보
  - JWT 토큰 검증
  - 사용자 정보 반환
- [ ] 2-5. `/api/auth/withdraw.ts` - 회원 탈퇴 API
  - JWT 토큰 검증
  - 연관 데이터 삭제 (CASCADE)
  - 사용자 삭제

### Phase 3: 프론트엔드 인증 연동
- [ ] 3-1. `AuthContext.tsx` 생성
  - 로그인 상태 관리
  - 토큰 저장 (localStorage)
- [ ] 3-2. 로그인/회원가입 페이지 UI 구현
- [ ] 3-3. 회원 탈퇴 UI 구현
- [ ] 3-4. 인증 상태에 따른 UI 분기

### Phase 4: 찜하기 API 구현
- [ ] 4-1. `/api/favorites/index.ts` - 찜 목록 조회 (GET)
- [ ] 4-2. `/api/favorites/[festivalId].ts` - 찜 추가/삭제 (POST/DELETE)
- [ ] 4-3. `FilterContext.tsx` 수정
  - 로그인 시 서버 동기화
  - 비로그인 시 localStorage fallback

### Phase 5: 리뷰 API 구현
- [ ] 5-1. `/api/reviews/[festivalId].ts` - 리뷰 조회/작성 (GET/POST)
- [ ] 5-2. `/api/reviews/delete/[reviewId].ts` - 리뷰 삭제 (DELETE)
- [ ] 5-3. `FestivalReviewSection.tsx` 수정
  - 서버에서 리뷰 조회
  - 서버로 리뷰 저장

### Phase 6: 배포
- [ ] 6-1. Vercel 환경변수 설정
  ```
  SUPABASE_URL=xxx
  SUPABASE_ANON_KEY=xxx
  JWT_SECRET=xxx
  ```
- [ ] 6-2. Vercel에 배포
- [ ] 6-3. 프로덕션 테스트

---

## 7. 비용 예상 (무료 범위)

| 서비스 | 무료 한도 | 예상 사용량 | 비용 |
|--------|----------|------------|------|
| Vercel | 100GB 대역폭 | ~1GB/월 | $0 |
| Supabase | 500MB DB, 2GB 전송 | ~50MB | $0 |
| 총 비용 | - | - | **$0** |

---

## 8. 검증 방법

1. 회원가입 테스트 (닉네임, 전화번호, 비밀번호)
2. 로그인 테스트 (전화번호 + 비밀번호)
3. 찜하기 동기화 테스트 (다른 브라우저에서 확인)
4. 리뷰 작성/조회 테스트
5. 회원 탈퇴 테스트 (연관 데이터 삭제 확인)
6. Vercel Preview 배포 테스트
7. 프로덕션 배포
